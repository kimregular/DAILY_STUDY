# 코드 개선 기록

## 1. 유저 프로필 사진 저장 로직 개선
### 개선 전
```java
// UserUtil
public String saveProfileImage(MultipartFile profileImage, User user) { 
  // 기존 프로필 이미지가 있으면 삭제 
  if(!Objects.isNull(user.getProfileImagePath())) { 
      deleteImage(user.getProfileImagePath()); 
  } 
  String basePath = "myVideos/" + user.getId() + "/images/profile"; 
  String fileName = UUID.randomUUID() + "_" + profileImage.getOriginalFilename(); 
  Path filePath = Paths.get(basePath, fileName); 
  try {
    Files.createDirectories(filePath.getParent()); 
    Files.write(filePath, profileImage.getBytes()); 
  } catch (IOException e) {
    throw new RuntimeException("프로필 사진 변경에 실패했습니다.", e); 
  } return filePath.toString(); 
} 

public String saveBackgroundImage(MultipartFile backgroundImage, User user) { 
  // 기존 배경 이미지가 있으면 삭제 
  if(!Objects.isNull(user.getBackgroundImagePath())) { 
    deleteImage(user.getBackgroundImagePath()); 
  } 
  String basePath = "myVideos/" + user.getId() + "/images/background"; 
  String fileName = UUID.randomUUID() + "_" + backgroundImage.getOriginalFilename(); 
  Path filePath = Paths.get(basePath, fileName); 
  try {
    Files.createDirectories(filePath.getParent()); 
    Files.write(filePath, backgroundImage.getBytes()); 
  } catch (IOException e) {
    throw new RuntimeException("배경 사진 변경에 실패했습니다.", e); 
  } return filePath.toString(); 
}
```

사진을 저장하는 로직은 똑같지만 사진 종류가 다르다는 이유만으로 저장하는 메서드 2개를 정의해버렸다. 

사진 종류에 따라서 위치만 다르게 저장하면 된다. 하지만 해당 문제해결 방안이 생각이 안 나서 중복되는 메서드가 하나 더 생겼다. 한층 더 복잡해진 클래스는 보너스다.

리팩토링 기획을 하던 중에 사진 종류를 상수로 만들어서 저장 위치를 동적으로 가져오자는 아이디어가 떠올랐다. 아래는 해당 아이디어 적용 후 결과이다.

### 개선 후
```java
// UserUtil
public String saveImage(MultipartFile profileImage, User user, UserImageType userImageType) { 
  if (!Objects.isNull(userImageType.getImagePathOf(user))) {
    deleteImage(userImageType.getImagePathOf(user));
  }
  String basePath = "myVideos/" + user.getId() + "/images/" + userImageType.getFolderName();
  String fileName = UUID.randomUUID() + "_" + profileImage.getOriginalFilename();
  Path filePath = Paths.get(basePath, fileName);
  try {
    Files.createDirectories(filePath.getParent());
    Files.write(filePath, profileImage.getBytes());
  } catch (IOException e) {
    throw new RuntimeException("프로필 사진 변경에 실패했습니다.", e);
  }
  return filePath.toString();
}
```

파라미터가 하나 더 추가되었다. 저장하고자 하는 이미지 타입을 지정하여 메서드를 호출하면 해당 타입에 맞는 사진의 경로를 유저 정보에 맞춰 반환해준다.

```java
// UserImageType
public enum UserImageType {

	PROFILE("profile"){
		@Override
		public String getImagePathOf(User user) {
			return user.getProfileImagePath();
		}
	},
	BACKGROUND("background"){
		@Override
		public String getImagePathOf(User user) {
			return user.getBackgroundImagePath();
		}
	};

	private final String folderName;

	public abstract String getImagePathOf(User user);

	UserImageType(String folderName) {
		this.folderName = folderName;
	}

	public String getFolderName() {
		return folderName;
	}
}
```

이미지타입 상수는 위와 같다. `getImagePathOf()` 추상 메서드를 필드에서 필요한 대로 정의하였다.

### 왜 람다식으로 작성하지 않았나요?
제가 아직 람다와는 어색한 사이여서요,,, 추후 리팩토링을 하게 된다면 도입해보겠습니다.