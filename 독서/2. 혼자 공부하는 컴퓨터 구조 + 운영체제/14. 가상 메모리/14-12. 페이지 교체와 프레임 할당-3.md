### 스래싱과 프레임 할당-1
페이지 폴트가 자주 발생하는 이유에 나쁜 페이지 교체 알고리즘만 있는 건 아니다. 프로세스가 사용할 수 있는 프레임 수가 적어도 페이지 폴트는 자주 발생한다. (사실 이것이 더 근본적인 이유라고 볼 수 있다.) 반대로 프로세스가 사용할 수 있는 프레임 수가 많으면 일반적으로 페이지 폴트 빈도는 감소한다. 극단적으로 프레임이 무한히 많은 컴퓨터와 프레임이 한 개 있는 컴퓨터를 비교해 보자. 전자는 페이지를 수용할 공간이 넉넉하여 모든 프로세스의 페이지가 메모리에 적재될 수 있기 때문에 페이지 폴트 발생 빈도가 적지만, 후자는 새로운 페이지를 참조할 때마다 페이지 폴트가 발생한다.

이처럼 프레임이 부족하면 CPU는 페이지 폴트가 자주 발생할 수밖에 없다. 실행의 맥이 탁 탁 끊기고, 결과적으로 CPU의 이용률도 떨어진다. CPU가 쉴새 없이 프로세스를 실행해야 컴퓨터 전체의 생산성도 올라갈 텐데, 페이지 교체에 너무 많은 시간을 쏟으면 당연히 성능에도 큰 악영향이 초래된다. 이처럼 프로세스가 실제 실행되는 시간보다 페이징에 더 많은 시간을 소요하여 성능이 저해되는 문제를 `스래싱 (thrashing)`이라고 한다.

스래싱을 그래프로 표현하면 아래와 같다. 세로축인 CPU 이용률을 통해 CPU가 얼마나 쉴 새 없이 일을 하고 있는지를 알 수 있다. 이 값이 높으면 CPU는 현재 일을 쉬지 않고 하고 있다는 의미이고, 이 값이 낮다면 CPU는 현재 일을 많이 하고 있지 않다는 것을 의미한다. 가로축인 멀티 프로그래밍의 정도를 통해 메모리에 올라와 있는 프로세스의 수를 알 수 있다. 메모리에서 동시 실행되는 프로세스의 수를 `멀티프로그래밍의 정도 (degree of multiprogramming)`라고 한다. 멀티프로그래밍의 정도가 높다면 현재 메모리에는 많은 프로세스가 동시에 실행 중이고, 낮다면 현재 메모리에는 적은 프로세스가 동시에 실행 중이라고 이해하면 된다.

![멀티프로그래밍의 정도](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhcNO6G9IVcH7qHFM0oLuXqX2qyyW3MDXerXwEPQY7vMm-b62RUc6rUZRH3qcbyGR7tv5A5tkku9w_OSxd7k8foJ6ZBfVcEK8TcwWL-oYWK7qaR70N1UuEYVoJ5VGbj4zSWu3moc2w20jc/s1600/Thrashing.jpg)

이 그래프는 동시에 실행되는 프로세스의 수 (멀티프로그래밍의 정도)를 늘린다고 해서 CPU 이용률이 그에 비례해서 증가하는 것이 아님을 나타낸다. 동시에 실행되는 프로세스 수가 어느 정도 증가하면 CPU 이용률이 높아지지만, 필요 이상으로 늘리면 각 프로세스들이 사용할 수 있는 프레임 수가 적어지기 때문에 페이지 폴트가 지나치게 빈번히 발생하고, 이에 따라 CPU 이용률이 떨어져 전체적인 성능이 저해되는 것이다. 아무리 CPU의 성능이 뛰어나도 동시에 실행되는 프로세스를 수용할 물리 메모리가 너무 작다면 전체 컴퓨터의 성능이 안 좋아지는 이유는 이러한 이유 때문이다.

스래싱이 발생하는 근본적인 원인은 각 프로세스가 필요로 하는 최소한의 프레임 수가 보장되지 않았기 때문이다. 가령 프로세스 A를 무리 없이 실행하기 위해서는 최소 열 개의 프레임이 필요한데도 불구하고 프로세스 A가 다섯 개의 프레임만 이용할 수 있다면 이 프로세스는 페이지 폴트가 자주 발생한다. 스래싱 발생 위험이 높아진다. 그렇기에 운영체제는 각 프로세스들이 무리 없이 실행하기 위한 최소한의 프레임 수를 파악하고 프로세스들에 적절한 수만큼 프레임을 할당해 줄 수 있어야 한다.

우선 가장 단순한 형태의 `프레임 할당 방식`부터 생각해 보자. 모든 프로세스에 균등하게 프레임을 제공하는 방식을 생각해 보자. 가령 세 개의 프로세스에 총 300개의 프레임을 할당할 수 있다면 각 프로세스에 100개의 프로세스를 할당하는 방식이다. 이러한 프레임 할당 방식을 `균등 할당 (equal allocation)`이라고 한다.

하지만 짐작할 수 있다시피 이는 그리 권장할 만한 방법이 아니다. 실행되는 프로세스들의 크기는 각기 다른데, 천편일률적으로 동일한 프레임 개수를 할당하는 것은 비합리적이다. 가령 크기가 상대적으로 큰 워드 프로세서와 상대적으로 작은 메모장이 동시에 실행된다면 워드 프로세서에 프레임을 더 많이 할당해 주고, 메모장에는 상대적으로 적은 프레임을 할당하는 것이 더 합리적이다. 이렇게 프로세스의 크기가 크면 프레임을 많이 할당하고 프로세스 크기가 작으면 프레임을 적게 나눠주는 방식을 `비례 할당 (proportional allocation)`이라고 한다.

균등 할당과 비례 할당 방식은 프로세스의 실행 과정을 고려하지 않고 단순히 프로세스의 크기와 물리 메모리의 크기만을 고려한 방식이라는 점에서 `정적 할당 방식`이라고도 한다.

하지만 비례 할당 또한 완벽한 방식은 아니다. 프로세스의 크기가 클지라도 막상 실행해 보니 많은 프레임을 필요로 하지 않는 경우도 있다. 반대로 프로세스의 크기가 작아도 실행해 보니 많은 프레임을 필요로 하는 경우도 있다. 즉, 하나의 프로세스가 실제로 얼마나 많은 프레임이 필요할지는 결국 실행해 봐야 아는 경우가 많다.

프로세스를 실행하는 과정에서 배분할 프레임을 결정하는 방식에는 크게 `작업 집합 모델 (working set model)`을 사용하는 방식과 `페이지 폴트 빈도 (PFF: Page-Fault Frequency)`를 사용하는 방식이 있다.

이 두 개의 방식은 프로세스의 실행을 보고 할당할 프레임 수를 결정한다는 점에서 `동적 할당 방식`이라고도 한다.

말이 어렵게 느껴질 수는 있지만, 사실 알고 보면 단순하다. 우선 작업 집합 모델 기반 프레임 할당 부터 알아보자. 스래싱이 발생하는 이유는 빈번한 페이지 교체 때문이다. 그렇기에 작업 집합 모델 기반 프레임 할당 방식은 '프로세스가 일정 기간 동안 참조한 페이지 집합'을 기억하여 빈번한 페이지 교체를 방지한다.

컴퓨터 구조에서 학습한 참조 지역성 원리를 기억해보자. CPU가 메모리를 참조할 때에는 참조 지역성 원리에 의거해 주로 비슷한 구역을 집중적으로 참조한다. 한 프로세스가 100개의 페이지로 이루어졌다고 해서 100개를 모두 고르게 참조하는 것이 아니라, 특정 시간 동안에는 몇몇 개의 페이지 (정확히는 몇 개의 페이지 내 주소들)만을 집중적으로 참조하게 된다.

그렇다면 CPU가 특정 시간 동안 주로 참조한 페이지 개수만큼만 프레임을 할당하면 페이지 교체는 빈번하게 발생하지 않는다. 만약 CPU가 어떤 프로세스를 실행하는 동안 3초에 일곱 개의 페이지를 집중적으로 참조했다면 운영체제는 그 프로세스를 위해 그 순간만큼은 최소 일곱 개의 프레임을 할당하면 된다. 또 만약 CPU가 어떤 프로세스를 실행하는 동안 3초에 20개의 페이지를 집중적으로 참조했다면 운영체제는 그 프로세스를 위해 그 순간만큼은 최소 20개의 프레임을 할당하면 된다.

실행 중인 프로세스가 일정 시간 동안 참조한 페이지의 집합을 `작업 집합 (working set)`이라고 한다. CPU가 과거에 주로 참조한 페이지를 작업 집합에 포함한다면 운영체제는 작업 집합의 크기만큼만 프레임을 할당해 주면 된다.

