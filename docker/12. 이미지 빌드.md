앞서 살펴봤듯이 현대의 인프라 구성에서 가장 중요한 개념 중 하나가 IaC 라는 방법론이다. IaC는 코드를 통해 인프라를 관리한다. 도커에서도 이 IaC 방법을 활용해서 코드로 이미지를 관리하는 방식이 이미지 빌드이다. 

자신이 서버 관리자라고 가정해보자. 나는 회사의 가상 머신을 관리해야 한다. 보통 가상 머신을 관리하는 대시보드에서 클릭을 하거나 명령어를 실행해서 작업을 수행한다. 그런데 만약 이 업무를 다른 사람에게 인수인계해야 하면 이런 작업 과정을 하나씩 캡쳐하거나 실행하는 명령어의 순서들을 가이드로 만들어야한다. 그리고 그 가이드를 새로운 사람이 다시 숙지해가면서 수행하다 보면 클릭하다가 실수를 할 수도 있고 전혀 다른 결과가 나오거나 장애가 발생할 위험도 있다. 이런 상황을 보통 휴먼 에러라고 부른다. 사람이 직접 인프라를 컨트롤하다 보면 실수가 나올 수 있다. 그리고 개인이 인프라를 관리하면 인프라의 상태를 변경한 기록들을 관리하기도 쉽지 않다. 

그래서 IaC 방법을 사용하면 코드로 인프라의 상태를 관리할 수 있다. 코드에 상세 작업 내용이 기제되어 있고 이 작업을 사람이 아닌 프로그램이 대신 수행해 주는 것이다. 프로그램이 작업을 하기 때문에 작업들을 더 빠르고 안전하게 실행할 수 있다. 코드에 들어가는 내용은 프로그램이 작업하기 위한 일련의 작업 명세서로 사용된다. 그리고 이런 명세서를 GitHub 같은 소스코드 레파지토리에 저장하면 인프라의 상태도 소스코드처럼 버전 관리를 할 수 있다. IaC를 활용하는 많은 프로그램이 있는데 도커도 그 중 하나다.

도커는 Docker File 이라는 소스코드를 사용해서 인프라의 상태를 저장하는 이미지를 만들 수 있다. 이를 도커의 커밋과 비교해보자. 커밋 방식은 이미지를 만들 때마다 컨테이너를 실행해야 되고 사용자가 명령어를 직업 입력해야 한다는 문제가 있다. 그리고 커밋 하나당 이미지의 레이어가 하나가 추가되기 때문에 여러 개의 레이어를 추가하고 싶을 때는 여러 번의 커밋을 수행해야 한다. 이런 방식은 복잡하기 때문에 사람이 직접 작업하면 문제가 발생할 가능성이 크다. 

그래서 도커 이미지를 생성할 때는 대부분 빌드 방식을 많이 사용한다. 빌드 방식은 컨테이너를 생성하고 커밋하는 것을 도커가 대신 수행해준다. 도커에게 어떤 작업을 수행할지를 코드로 작성한 것이 바로 이 도커 파일이다. 이미지 제작자가 도커가 이해할 수 있는 문법에 따라서 도커 파일을 작성하면 도커는 임시로 컨테이너를 실행하고 사용자가 정의한 작업을 수행한 뒤에 커밋을 실행한다. 그래서 도커 빌드를 활용하면 여러 개의 레이어도 쉽게 추가할 수 있다.

레이어를 한 장 추가한 다음에 다시 그 레이어로 만든 이미지를 컨테이너로 만들고 그 컨테이너 위에서 변경 작업을 한 다음에 추가로 커밋하느 것을 도커가 알아서 반복해줍니다. 정리하자면 도커는 IaC 방식에 따라서 이미지를 도커 파일이라느 소스 코드로 관리할 수 있다. 코드이기 때문에 애플리케이션 소스 코드와도 함께 관리할 수 있고 버전 관리도 할 수 있다. 도커 파일에는 이미지를 어떻게 만드는지에 대한 세부 내용이 기재되어 있다. 도커는 이 도커 파일을 해석해서 이미지를 제작해준다. 

이미지 빌드는 도커에서 가장 많이 사용되는 기능 중 하나이다. 컨테이너 애플리케이션 개발에 있어서 가장 핵심 기능이라고 볼 수 있다. 이미지는 도커 빌드 명령을 통해서 빌드할 수 있다.

`docker build -t 이미지명 Dockerfile경로`

`-t` 옵션 뒤에 빌드할 이미지의 이름을 입력하면 된다. 그리고 도커 파일이 저장되어 있는 경로를 지정해서 이미지를 빌드할 수 있다. 

이미지를 빌드하기 위해선 문법에 맞게 도커 파일을 작성해야 한다. 도커 파일의 문법은 지시어와 지시어의 옵션으로 구성된다.

```dockerfile
FROM 이미지명
# 베이스 이미지를 지정
COPY 파일경로 복사할경로
# 파일을 레이어에 복사
CMD ["명령어"]
# 컨테이너 실행 시 명령어 지정
```

따라서 도커 파일을 작성하려면 각각의 지시어들이 어떤 역할을 하는지, 어떤 옵션 값을 어떻게 넣어야 하는지에 대해서 알아두어야 한다.

그러면 가장 기본이 되는 `FROM`, `COPY`, `CMD` 지시어부터 알아보자.

## FROM
새롭게 빌드할 이미지에 기반이 되는 베이스 이미지를 지정한다. 시작접 역할을 하는 이미지를 베이스 이미지라고 부른다. 그래서 FROM에는 이 이미지를 빌드할 때 처음 시작할 베이스 이미지의 이름을 지정하면 된다. 그래서 FROM 지시어는 도커 파일에서 필수로 표시해야 한다. 보통 이미지를 빌드할 때 필요한 파일 시스템이 있는 이미지를 베이스 이미지로 지정하는 것이 좋다. 

예를 들어서 Node.js 애플리케이션을 실행하려면 Node.js가 설치되어 있는 이미지를 베이스 이미지로 선택하는 것이 좋다. 자바 애플리케이션을 실행하려면 자바 런타임이 설치된 이미지를 베이스 이미지로 선택하는 것이 좋다. 

## COPY
다음으로 COPY 지시어는 원하는 파일을 레이어에 복사할 수 있다. 

## CMD
CMD 지시어는 이미지를 컨테이너로 실행할 때 이 컨테이너 안에서 프로그램을 실행할 명령어를 지정한다. CMD 지시어에 작성한 명령어는 메타데이터의 CMD 필으에 저장된다. 